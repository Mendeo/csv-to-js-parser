<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: node_modules/mocha/lib/cli/options.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: node_modules/mocha/lib/cli/options.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * Main entry point for handling filesystem-based configuration,
 * whether that's a config file or `package.json` or whatever.
 * @module lib/cli/options
 * @private
 */

const fs = require('fs');
const ansi = require('ansi-colors');
const yargsParser = require('yargs-parser');
const {types, aliases} = require('./run-option-metadata');
const {ONE_AND_DONE_ARGS} = require('./one-and-dones');
const mocharc = require('../mocharc.json');
const {list} = require('./run-helpers');
const {loadConfig, findConfig} = require('./config');
const findUp = require('find-up');
const debug = require('debug')('mocha:cli:options');
const {isNodeFlag} = require('./node-flags');
const {createUnparsableFileError} = require('../errors');

/**
 * The `yargs-parser` namespace
 * @external yargsParser
 * @see {@link https://npm.im/yargs-parser}
 */

/**
 * An object returned by a configured `yargs-parser` representing arguments
 * @memberof external:yargsParser
 * @interface Arguments
 */

/**
 * Base yargs parser configuration
 * @private
 */
const YARGS_PARSER_CONFIG = {
  'combine-arrays': true,
  'short-option-groups': false,
  'dot-notation': false,
  'strip-aliased': true
};

/**
 * This is the config pulled from the `yargs` property of Mocha's
 * `package.json`, but it also disables camel case expansion as to
 * avoid outputting non-canonical keynames, as we need to do some
 * lookups.
 * @private
 * @ignore
 */
const configuration = Object.assign({}, YARGS_PARSER_CONFIG, {
  'camel-case-expansion': false
});

/**
 * This is a really fancy way to:
 * - `array`-type options: ensure unique values and evtl. split comma-delimited lists
 * - `boolean`/`number`/`string`- options: use last element when given multiple times
 * This is passed as the `coerce` option to `yargs-parser`
 * @private
 * @ignore
 */
const globOptions = ['spec', 'ignore'];
const coerceOpts = Object.assign(
  types.array.reduce(
    (acc, arg) =>
      Object.assign(acc, {
        [arg]: v => Array.from(new Set(globOptions.includes(arg) ? v : list(v)))
      }),
    {}
  ),
  types.boolean
    .concat(types.string, types.number)
    .reduce(
      (acc, arg) =>
        Object.assign(acc, {[arg]: v => (Array.isArray(v) ? v.pop() : v)}),
      {}
    )
);

/**
 * We do not have a case when multiple arguments are ever allowed after a flag
 * (e.g., `--foo bar baz quux`), so we fix the number of arguments to 1 across
 * the board of non-boolean options.
 * This is passed as the `narg` option to `yargs-parser`
 * @private
 * @ignore
 */
const nargOpts = types.array
  .concat(types.string, types.number)
  .reduce((acc, arg) => Object.assign(acc, {[arg]: 1}), {});

/**
 * Wrapper around `yargs-parser` which applies our settings
 * @param {string|string[]} args - Arguments to parse
 * @param {Object} defaultValues - Default values of mocharc.json
 * @param  {...Object} configObjects - `configObjects` for yargs-parser
 * @private
 * @ignore
 */
const parse = (args = [], defaultValues = {}, ...configObjects) => {
  // save node-specific args for special handling.
  // 1. when these args have a "=" they should be considered to have values
  // 2. if they don't, they just boolean flags
  // 3. to avoid explicitly defining the set of them, we tell yargs-parser they
  //    are ALL boolean flags.
  // 4. we can then reapply the values after yargs-parser is done.
  const nodeArgs = (Array.isArray(args) ? args : args.split(' ')).reduce(
    (acc, arg) => {
      const pair = arg.split('=');
      let flag = pair[0];
      if (isNodeFlag(flag, false)) {
        flag = flag.replace(/^--?/, '');
        return arg.includes('=')
          ? acc.concat([[flag, pair[1]]])
          : acc.concat([[flag, true]]);
      }
      return acc;
    },
    []
  );

  const result = yargsParser.detailed(args, {
    configuration,
    configObjects,
    default: defaultValues,
    coerce: coerceOpts,
    narg: nargOpts,
    alias: aliases,
    string: types.string,
    array: types.array,
    number: types.number,
    boolean: types.boolean.concat(nodeArgs.map(pair => pair[0]))
  });
  if (result.error) {
    console.error(ansi.red(`Error: ${result.error.message}`));
    process.exit(1);
  }

  // reapply "=" arg values from above
  nodeArgs.forEach(([key, value]) => {
    result.argv[key] = value;
  });

  return result.argv;
};

/**
 * Given path to config file in `args.config`, attempt to load &amp; parse config file.
 * @param {Object} [args] - Arguments object
 * @param {string|boolean} [args.config] - Path to config file or `false` to skip
 * @public
 * @alias module:lib/cli.loadRc
 * @returns {external:yargsParser.Arguments|void} Parsed config, or nothing if `args.config` is `false`
 */
const loadRc = (args = {}) => {
  if (args.config !== false) {
    const config = args.config || findConfig();
    return config ? loadConfig(config) : {};
  }
};

module.exports.loadRc = loadRc;

/**
 * Given path to `package.json` in `args.package`, attempt to load config from `mocha` prop.
 * @param {Object} [args] - Arguments object
 * @param {string|boolean} [args.config] - Path to `package.json` or `false` to skip
 * @public
 * @alias module:lib/cli.loadPkgRc
 * @returns {external:yargsParser.Arguments|void} Parsed config, or nothing if `args.package` is `false`
 */
const loadPkgRc = (args = {}) => {
  let result;
  if (args.package === false) {
    return result;
  }
  result = {};
  const filepath = args.package || findUp.sync(mocharc.package);
  if (filepath) {
    try {
      const pkg = JSON.parse(fs.readFileSync(filepath, 'utf8'));
      if (pkg.mocha) {
        debug('`mocha` prop of package.json parsed: %O', pkg.mocha);
        result = pkg.mocha;
      } else {
        debug('no config found in %s', filepath);
      }
    } catch (err) {
      if (args.package) {
        throw createUnparsableFileError(
          `Unable to read/parse ${filepath}: ${err}`,
          filepath
        );
      }
      debug('failed to read default package.json at %s; ignoring', filepath);
    }
  }
  return result;
};

module.exports.loadPkgRc = loadPkgRc;

/**
 * Priority list:
 *
 * 1. Command-line args
 * 2. RC file (`.mocharc.c?js`, `.mocharc.ya?ml`, `mocharc.json`)
 * 3. `mocha` prop of `package.json`
 * 4. default configuration (`lib/mocharc.json`)
 *
 * If a {@link module:lib/cli/one-and-dones.ONE_AND_DONE_ARGS "one-and-done" option} is present in the `argv` array, no external config files will be read.
 * @summary Parses options read from `.mocharc.*` and `package.json`.
 * @param {string|string[]} [argv] - Arguments to parse
 * @public
 * @alias module:lib/cli.loadOptions
 * @returns {external:yargsParser.Arguments} Parsed args from everything
 */
const loadOptions = (argv = []) => {
  let args = parse(argv);
  // short-circuit: look for a flag that would abort loading of options
  if (
    Array.from(ONE_AND_DONE_ARGS).reduce(
      (acc, arg) => acc || arg in args,
      false
    )
  ) {
    return args;
  }

  const rcConfig = loadRc(args);
  const pkgConfig = loadPkgRc(args);

  if (rcConfig) {
    args.config = false;
    args._ = args._.concat(rcConfig._ || []);
  }
  if (pkgConfig) {
    args.package = false;
    args._ = args._.concat(pkgConfig._ || []);
  }

  args = parse(args._, mocharc, args, rcConfig || {}, pkgConfig || {});

  // recombine positional arguments and "spec"
  if (args.spec) {
    args._ = args._.concat(args.spec);
    delete args.spec;
  }

  // make unique
  args._ = Array.from(new Set(args._));

  return args;
};

module.exports.loadOptions = loadOptions;
module.exports.YARGS_PARSER_CONFIG = YARGS_PARSER_CONFIG;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Base.html">Base</a></li><li><a href="module-Context.html">Context</a></li><li><a href="module-Doc.html">Doc</a></li><li><a href="module-Dot.html">Dot</a></li><li><a href="module-HTML.html">HTML</a></li><li><a href="module-JSON.html">JSON</a></li><li><a href="module-JSONStream.html">JSONStream</a></li><li><a href="module-Landing.html">Landing</a></li><li><a href="module-List.html">List</a></li><li><a href="module-Markdown.html">Markdown</a></li><li><a href="module-Min.html">Min</a></li><li><a href="module-Nyan.html">Nyan</a></li><li><a href="module-Pending.html">Pending</a></li><li><a href="module-Progress.html">Progress</a></li><li><a href="module-Spec.html">Spec</a></li><li><a href="module-TAP.html">TAP</a></li><li><a href="module-XUnit.html">XUnit</a></li><li><a href="module-browser_Progress.html">browser/Progress</a></li><li><a href="module-interfaces_common.html">interfaces/common</a></li><li><a href="module-lib_cli.html">lib/cli</a></li><li><a href="module-node_modules_mocha_lib_errors.html">node_modules/mocha/lib/errors</a></li><li><a href="module-node_modules_mocha_lib_stats-collector.html">node_modules/mocha/lib/stats-collector</a></li><li><a href="module-node_modules_mocha_mocha.html">node_modules/mocha/mocha</a></li><li><a href="module-nodejs_reporters_parallel-buffered.html">nodejs/reporters/parallel-buffered</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Externals</h3><ul><li><a href="external-EventEmitter.html">EventEmitter</a></li><li><a href="external-yargsParser.html">yargsParser</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-lib_errors.constants.html">constants</a></li><li><a href="module-lib_errors.constants$4.html">constants$4</a></li></ul><h3>Classes</h3><ul><li><a href="-_anonymous_-__webpack_modules__.345-Pool.html">Pool</a></li><li><a href="-_anonymous_-__webpack_modules__.751-WorkerHandler.html">WorkerHandler</a></li><li><a href="CascadingConfigArrayFactory.html">CascadingConfigArrayFactory</a></li><li><a href="ConfigArray.html">ConfigArray</a></li><li><a href="ConfigArrayFactory.html">ConfigArrayFactory</a></li><li><a href="ConfigDependency.html">ConfigDependency</a></li><li><a href="ConfigurationNotFoundError.html">ConfigurationNotFoundError</a></li><li><a href="DirEntry.html">DirEntry</a></li><li><a href="ExtractedConfig.html">ExtractedConfig</a></li><li><a href="FSWatcher.html">FSWatcher</a></li><li><a href="FlatCompat.html">FlatCompat</a></li><li><a href="Hook.html">Hook</a></li><li><a href="IgnorePattern.html">IgnorePattern</a></li><li><a href="Mocha.html">Mocha</a></li><li><a href="Mocha.reporters.Base.html">Base</a></li><li><a href="Mocha.reporters.Doc.html">Doc</a></li><li><a href="Mocha.reporters.Dot.html">Dot</a></li><li><a href="Mocha.reporters.HTML.html">HTML</a></li><li><a href="Mocha.reporters.JSON.html">JSON</a></li><li><a href="Mocha.reporters.JSONStream.html">JSONStream</a></li><li><a href="Mocha.reporters.Landing.html">Landing</a></li><li><a href="Mocha.reporters.List.html">List</a></li><li><a href="Mocha.reporters.Markdown.html">Markdown</a></li><li><a href="Mocha.reporters.Min.html">Min</a></li><li><a href="Mocha.reporters.Nyan.html">Nyan</a></li><li><a href="Mocha.reporters.Progress.html">Progress</a></li><li><a href="Mocha.reporters.Spec.html">Spec</a></li><li><a href="Mocha.reporters.TAP.html">TAP</a></li><li><a href="Mocha.reporters.XUnit.html">XUnit</a></li><li><a href="OverrideTester.html">OverrideTester</a></li><li><a href="PluginConflictError.html">PluginConflictError</a></li><li><a href="Pool.html">Pool</a></li><li><a href="Runnable.html">Runnable</a></li><li><a href="Runner.html">Runner</a></li><li><a href="Suite.html">Suite</a></li><li><a href="Test.html">Test</a></li><li><a href="TokenTranslator.html">TokenTranslator</a></li><li><a href="WorkerHandler.html">WorkerHandler</a></li><li><a href="module-Context-Mocha.html">Mocha</a></li><li><a href="module-node_modules_mocha_mocha-Runner.html">Runner</a></li><li><a href="module-nodejs_reporters_parallel-buffered-ParallelBuffered.html">ParallelBuffered</a></li><li><a href="module-parallel-buffered-runner-ParallelBufferedRunner.html">ParallelBufferedRunner</a></li></ul><h3>Interfaces</h3><ul><li><a href="external-yargsParser.Arguments.html">Arguments</a></li></ul><h3>Mixins</h3><ul><li><a href="FsEventsHandler.html">FsEventsHandler</a></li><li><a href="NodeFsHandler.html">NodeFsHandler</a></li></ul><h3>Global</h3><ul><li><a href="global.html"></a></li><li><a href="global.html#Ajv">Ajv</a></li><li><a href="global.html#CHILD_PROCESS_EXIT_TIMEOUT">CHILD_PROCESS_EXIT_TIMEOUT</a></li><li><a href="global.html#CancellationError">CancellationError</a></li><li><a href="global.html#DOT_LITERAL">DOT_LITERAL</a></li><li><a href="global.html#Date">Date</a></li><li><a href="global.html#ESPRIMA_FINISH_NODE">ESPRIMA_FINISH_NODE</a></li><li><a href="global.html#FSEventsWatchers">FSEventsWatchers</a></li><li><a href="global.html#FsWatchInstances">FsWatchInstances</a></li><li><a href="global.html#KEYS">KEYS</a></li><li><a href="global.html#POSIX_REGEX_SOURCE">POSIX_REGEX_SOURCE</a></li><li><a href="global.html#Promise">Promise</a></li><li><a href="global.html#TERMINATE_METHOD_ID">TERMINATE_METHOD_ID</a></li><li><a href="global.html#TimeoutError">TimeoutError</a></li><li><a href="global.html#WINDOWS_CHARS">WINDOWS_CHARS</a></li><li><a href="global.html#addFormat">addFormat</a></li><li><a href="global.html#addKeyword">addKeyword</a></li><li><a href="global.html#addMetaSchema">addMetaSchema</a></li><li><a href="global.html#addSchema">addSchema</a></li><li><a href="global.html#anymatch">anymatch</a></li><li><a href="global.html#base">base</a></li><li><a href="global.html#baseMinusTMin">baseMinusTMin</a></li><li><a href="global.html#braces">braces</a></li><li><a href="global.html#cancel">cancel</a></li><li><a href="global.html#checkCompiling">checkCompiling</a></li><li><a href="global.html#collect">collect</a></li><li><a href="global.html#colorConvert">colorConvert</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#compIndex">compIndex</a></li><li><a href="global.html#compile">compile</a></li><li><a href="global.html#compileAsync">compileAsync</a></li><li><a href="global.html#createBaseConfigArray">createBaseConfigArray</a></li><li><a href="global.html#createCLIConfigArray">createCLIConfigArray</a></li><li><a href="global.html#createConfig">createConfig</a></li><li><a href="global.html#createContext">createContext</a></li><li><a href="global.html#createFSEventsInstance">createFSEventsInstance</a></li><li><a href="global.html#createFsWatchInstance">createFsWatchInstance</a></li><li><a href="global.html#createPattern">createPattern</a></li><li><a href="global.html#csvToObj">csvToObj</a></li><li><a href="global.html#deleteMutationMethods">deleteMutationMethods</a></li><li><a href="global.html#dirSuffix">dirSuffix</a></li><li><a href="global.html#emitDeprecationWarning">emitDeprecationWarning</a></li><li><a href="global.html#encloseBrace">encloseBrace</a></li><li><a href="global.html#endCompiling">endCompiling</a></li><li><a href="global.html#ensurePluginMemberMaps">ensurePluginMemberMaps</a></li><li><a href="global.html#environments">environments</a></li><li><a href="global.html#errors">errors</a></li><li><a href="global.html#errorsText">errorsText</a></li><li><a href="global.html#escapeNode">escapeNode</a></li><li><a href="global.html#exceedsLimit">exceedsLimit</a></li><li><a href="global.html#expandRange">expandRange</a></li><li><a href="global.html#filterKey">filterKey</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#fmtLong">fmtLong</a></li><li><a href="global.html#fmtShort">fmtShort</a></li><li><a href="global.html#formatArgs">formatArgs</a></li><li><a href="global.html#formatErrors">formatErrors</a></li><li><a href="global.html#fsWatchBroadcast">fsWatchBroadcast</a></li><li><a href="global.html#getCommonAncestorPath">getCommonAncestorPath</a></li><li><a href="global.html#getDiff">getDiff</a></li><li><a href="global.html#getKeys">getKeys</a></li><li><a href="global.html#getKeyword">getKeyword</a></li><li><a href="global.html#getLatestEcmaVersion">getLatestEcmaVersion</a></li><li><a href="global.html#getMatchedIndices">getMatchedIndices</a></li><li><a href="global.html#getNamespaceFromTerm">getNamespaceFromTerm</a></li><li><a href="global.html#getRuleOptionsSchema">getRuleOptionsSchema</a></li><li><a href="global.html#getRuleSeverity">getRuleSeverity</a></li><li><a href="global.html#getSchema">getSchema</a></li><li><a href="global.html#getShorthandName">getShorthandName</a></li><li><a href="global.html#getSupportedEcmaVersions">getSupportedEcmaVersions</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initPluginMemberMaps">initPluginMemberMaps</a></li><li><a href="global.html#inspectOpts">inspectOpts</a></li><li><a href="global.html#internalSlotsMap">internalSlotsMap</a></li><li><a href="global.html#internalSlotsMap$1">internalSlotsMap$1</a></li><li><a href="global.html#internalSlotsMap$2">internalSlotsMap$2</a></li><li><a href="global.html#isErrorSeverity">isErrorSeverity</a></li><li><a href="global.html#isEverySeverityValid">isEverySeverityValid</a></li><li><a href="global.html#isFilePath">isFilePath</a></li><li><a href="global.html#isInteger">isInteger</a></li><li><a href="global.html#isInvalidBrace">isInvalidBrace</a></li><li><a href="global.html#isNonNullObject">isNonNullObject</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isOpenOrClose">isOpenOrClose</a></li><li><a href="global.html#isPromise">isPromise</a></li><li><a href="global.html#isValidSeverity">isValidSeverity</a></li><li><a href="global.html#load">load</a></li><li><a href="global.html#localstorage">localstorage</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#matchPatterns">matchPatterns</a></li><li><a href="global.html#maxInt">maxInt</a></li><li><a href="global.html#mergePlugins">mergePlugins</a></li><li><a href="global.html#mergeRuleConfigs">mergeRuleConfigs</a></li><li><a href="global.html#mergeWithoutOverwrite">mergeWithoutOverwrite</a></li><li><a href="global.html#mocha">mocha</a></li><li><a href="global.html#normalizeConfigGlobal">normalizeConfigGlobal</a></li><li><a href="global.html#normalizeEcmaVersion">normalizeEcmaVersion</a></li><li><a href="global.html#normalizeOptions">normalizeOptions</a></li><li><a href="global.html#normalizePlugin">normalizePlugin</a></li><li><a href="global.html#normalizeSourceType">normalizeSourceType</a></li><li><a href="global.html#normalizeToStrings">normalizeToStrings</a></li><li><a href="global.html#normalizedPlugins">normalizedPlugins</a></li><li><a href="global.html#objectToError">objectToError</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#patternToJson">patternToJson</a></li><li><a href="global.html#picomatch">picomatch</a></li><li><a href="global.html#plural">plural</a></li><li><a href="global.html#pool">pool</a></li><li><a href="global.html#punycode">punycode</a></li><li><a href="global.html#raise">raise</a></li><li><a href="global.html#raiseRecoverable">raiseRecoverable</a></li><li><a href="global.html#rangeToPattern">rangeToPattern</a></li><li><a href="global.html#readdirp">readdirp</a></li><li><a href="global.html#reduce">reduce</a></li><li><a href="global.html#regexPunycode">regexPunycode</a></li><li><a href="global.html#relative">relative</a></li><li><a href="global.html#removeKeyword">removeKeyword</a></li><li><a href="global.html#removeSchema">removeSchema</a></li><li><a href="global.html#resolve">resolve</a></li><li><a href="global.html#resolveSchema">resolveSchema</a></li><li><a href="global.html#s">s</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#scan">scan</a></li><li><a href="global.html#setFSEventsListener">setFSEventsListener</a></li><li><a href="global.html#setFsWatchFileListener">setFsWatchFileListener</a></li><li><a href="global.html#setFsWatchListener">setFsWatchListener</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#startsWith">startsWith</a></li><li><a href="global.html#syntaxError">syntaxError</a></li><li><a href="global.html#then">then</a></li><li><a href="global.html#timeout">timeout</a></li><li><a href="global.html#toMatcher">toMatcher</a></li><li><a href="global.html#translateESLintRC">translateESLintRC</a></li><li><a href="global.html#tty">tty</a></li><li><a href="global.html#ucs2length">ucs2length</a></li><li><a href="global.html#unexpected">unexpected</a></li><li><a href="global.html#unionWith">unionWith</a></li><li><a href="global.html#useColors">useColors</a></li><li><a href="global.html#validate">validate</a></li><li><a href="global.html#validateConfigArray">validateConfigArray</a></li><li><a href="global.html#validateConfigSchema">validateConfigSchema</a></li><li><a href="global.html#validateEnvironment">validateEnvironment</a></li><li><a href="global.html#validateGlobals">validateGlobals</a></li><li><a href="global.html#validateKeyword">validateKeyword</a></li><li><a href="global.html#validateMaxWorkers">validateMaxWorkers</a></li><li><a href="global.html#validateMinWorkers">validateMinWorkers</a></li><li><a href="global.html#validateProcessor">validateProcessor</a></li><li><a href="global.html#validateRuleOptions">validateRuleOptions</a></li><li><a href="global.html#validateRuleSchema">validateRuleSchema</a></li><li><a href="global.html#validateRuleSeverity">validateRuleSeverity</a></li><li><a href="global.html#validateRules">validateRules</a></li><li><a href="global.html#validateSchema">validateSchema</a></li><li><a href="global.html#watch">watch</a></li><li><a href="global.html#worker">worker</a></li><li><a href="global.html#workerEmit">workerEmit</a></li><li><a href="global.html#writeDebugLogForLoading">writeDebugLogForLoading</a></li><li><a href="global.html#zip">zip</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 10:36:43 GMT+0300 (Москва, стандартное время)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
